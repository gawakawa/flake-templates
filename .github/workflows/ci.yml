name: "CI"

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  tests:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6

      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GH_TOKEN }}

      - name: Flake check
        run: nix flake check

  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      templates: ${{ steps.set-templates.outputs.templates }}
      haskell: ${{ steps.filter.outputs.haskell == 'true' || steps.filter.outputs.root == 'true' }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GH_TOKEN }}

      - name: List all templates
        id: list-templates
        uses: ./.github/actions/list-templates

      - name: Generate filters
        run: |
          {
            echo "root:"
            echo "  - 'flake.nix'"
            echo "  - 'flake.lock'"
            echo '${{ steps.list-templates.outputs.templates }}' | jq -r '.[] | "\(.):\n  - \"templates/\(.)/**\""'
          } > filters.yml

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: filters.yml

      - name: Set templates to test
        id: set-templates
        run: |
          if [[ "${{ steps.filter.outputs.root }}" == "true" ]]; then
            printf 'templates=%s\n' '${{ steps.list-templates.outputs.templates }}' >> "$GITHUB_OUTPUT"
          else
            printf 'templates=%s\n' '${{ steps.filter.outputs.changes }}' >> "$GITHUB_OUTPUT"
          fi

  test-templates:
    needs: detect-changes
    timeout-minutes: 60
    if: needs.detect-changes.outputs.templates != '[]'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        template: ${{ fromJSON(needs.detect-changes.outputs.templates) }}
        exclude:
          - os: macos-latest
            template: purs-nix
          - os: macos-latest
            template: haskell
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6

      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GH_TOKEN }}

      - uses: cachix/cachix-action@v16
        with:
          name: gawakawa
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Check ${{ matrix.template }} template
        if: matrix.template != 'haskell'
        working-directory: templates/${{ matrix.template }}
        run: nix flake check

      - name: Test devShell for ${{ matrix.template }} template
        if: matrix.template != 'haskell'
        working-directory: templates/${{ matrix.template }}
        run: nix develop -c echo "DevShell works"

  test-haskell:
    needs: detect-changes
    if: needs.detect-changes.outputs.haskell == 'true'
    uses: ./.github/workflows/ci-haskell.yml
    secrets: inherit

  ci-success:
    needs: [tests, test-templates, test-haskell]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - run: exit 1
        if: |
          needs.tests.result != 'success' ||
          (needs.test-templates.result != 'success' && needs.test-templates.result != 'skipped') ||
          (needs.test-haskell.result != 'success' && needs.test-haskell.result != 'skipped')
